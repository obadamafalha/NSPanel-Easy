---
name: Validate YAML (secondary files)

# yamllint disable-line rule:truthy
on:
  push:
    paths:
      - '**/*.yml'
      - '**/*.yaml'
  pull_request:
    paths:
      - '**/*.yml'
      - '**/*.yaml'
  workflow_dispatch:

jobs:
  code_scan:
    name: Validate YAML
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          fetch-depth: '0'

      - name: Identify changed files
        uses: tj-actions/changed-files@v47.0.1
        id: changed-files
        with:
          files: '**/*.y*ml'
          separator: ","

      - name: Validate YAML
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          set -e
          failed=0
          IFS=',' read -ra FILES <<< "${{ steps.changed-files.outputs.all_changed_files }}"
          for file in "${FILES[@]}"; do
            if [[ "$file" =~ ^nspanel_esphome.*\.yaml$ ]] || \
              [[ "$file" =~ ^esphome/nspanel_esphome.*\.yaml$ ]] || \
              [[ "$file" =~ ^prebuilt/nspanel_esphome.*\.yaml$ ]] || \
              [[ "$file" == "nspanel_easy_blueprint.yaml" ]]; then
              echo "Skipping $file"
              continue
            fi
            echo "::group::Validating $file"
            if ! yamllint -c "./.rules/yamllint.yml" "$file"; then
              failed=1
            fi
            echo "::endgroup::"
          done
          exit $failed
...
